<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„ä¸ªäººä»»åŠ¡ç®¡ç†å™¨</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.4;
            color: #333;
            background: #f8f9fa;
            padding: 15px;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            margin: 15px 0;
            color: #2c3e50;
            font-size: 1.5em;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .btn-primary {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            white-space: nowrap;
        }
        .btn-primary:hover {
            background: #2980b9;
        }
        .btn-success {
            background: #27ae60;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            white-space: nowrap;
        }
        .btn-success:hover {
            background: #219a52;
        }
        .btn-edit {
            background: #f39c12;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            white-space: nowrap;
        }
        .btn-edit:hover {
            background: #e67e22;
        }
        .btn-danger {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            white-space: nowrap;
        }
        .btn-danger:hover {
            background: #c0392b;
        }
        .btn-sort {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            white-space: nowrap;
        }
        .btn-sort:hover {
            background: #7f8c8d;
        }
        .btn-sort.active {
            background: #3498db;
        }

        .sort-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        .project-card {
            background: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-left: 3px solid #3498db;
            display: flex;
            flex-direction: column;
            position: relative;
            padding-bottom: 40px;
        }
        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
            gap: 8px;
        }
        .project-title {
            font-size: 14px;
            font-weight: bold;
            color: #2c3e50;
            line-height: 1.3;
            flex: 1;
        }
        .project-description {
            color: #7f8c8d;
            font-size: 12px;
            margin-bottom: 8px;
            line-height: 1.3;
            font-style: italic;
        }
        .project-meta {
            color: #7f8c8d;
            font-size: 12px;
            margin-bottom: 8px;
            line-height: 1.3;
        }
        .time-display {
            color: #e74c3c;
            font-weight: bold;
            font-size: 11px;
        }
        .next-time {
            color: #e74c3c;
            font-weight: bold;
            font-size: 11px;
        }
        .progress-container {
            margin: 10px 0;
        }
        .progress-bar {
            width: 100%;
            height: 16px;
            background: #ecf0f1;
            border-radius: 8px;
            overflow: hidden;
        }
        .progress {
            height: 100%;
            background: linear-gradient(90deg, #27ae60, #2ecc71);
            transition: width 0.3s ease;
        }
        .progress-text {
            text-align: center;
            font-size: 11px;
            color: #7f8c8d;
            margin-top: 3px;
        }
        .project-actions {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin: 10px 0;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            grid-column: 1 / -1;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        .stat-card {
            background: white;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .stat-number {
            font-size: 1.5em;
            font-weight: bold;
            color: #3498db;
        }
        .stat-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 4px;
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
        .form-container {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 1000;
            width: 95%;
            max-width: 450px;
            max-height: 85vh;
            overflow-y: auto;
        }
        .form-title {
            margin-bottom: 15px;
            color: #2c3e50;
            text-align: center;
            font-size: 1.2em;
        }
        .form-group {
            margin: 10px 0;
        }
        label {
            display: block;
            margin-bottom: 4px;
            font-weight: bold;
            color: #34495e;
            font-size: 13px;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 13px;
        }
        textarea {
            resize: vertical;
            min-height: 60px;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
        }
        .form-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .form-section {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 4px;
            margin: 12px 0;
        }
        .form-section-title {
            font-size: 14px;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        small {
            color: #7f8c8d;
            font-size: 11px;
        }

        .reset-badge {
            background: #3498db;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            margin-right: 8px;
        }

        /* ç”¨æˆ·æ ‡ç­¾æ ·å¼ - åº•éƒ¨å¯¼èˆªå½¢å¼ */
        .user-tags {
            display: flex;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            border-radius: 0 0 6px 6px;
            padding: 6px;
            gap: 1px;
        }
        .user-tag {
            flex: 1;
            background: #ecf0f1;
            color: #7f8c8d;
            padding: 6px 4px;
            font-size: 10px;
            cursor: pointer;
            border: none;
            text-align: center;
            transition: all 0.2s ease;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .user-tag:hover {
            background: #d5dbdb;
        }
        .user-tag.active {
            background: #3498db;
            color: white;
        }
        .user-tag:first-child {
            border-radius: 0 0 0 6px;
        }
        .user-tag:last-child {
            border-radius: 0 0 6px 0;
        }

        .tag-input-group {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        .tag-input {
            flex: 1;
            padding: 6px;
            font-size: 12px;
        }
        .add-tag-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .tag-list {
            margin-top: 8px;
        }
        .tag-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 8px;
            background: #f8f9fa;
            margin: 2px 0;
            border-radius: 4px;
        }
        .remove-tag {
            color: #e74c3c;
            cursor: pointer;
            margin-left: 8px;
            font-size: 12px;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            color: white;
            font-size: 14px;
            z-index: 1001;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }
        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }
        .toast.success {
            background: #27ae60;
        }
        .toast.info {
            background: #3498db;
        }
        .toast.error {
            background: #e74c3c;
        }

        /* ç™»å½•è¡¨å•æ ·å¼ */
        .login-container {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 1001;
            width: 95%;
            max-width: 400px;
        }
        .login-title {
            text-align: center;
            margin-bottom: 20px;
            color: #2c3e50;
        }
        .login-input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 14px;
        }
        .login-btn {
            width: 100%;
            padding: 12px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }
        .login-btn:hover {
            background: #2980b9;
        }
        .login-error {
            color: #e74c3c;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        @media (max-width: 768px) {
            .projects-grid {
                grid-template-columns: 1fr;
            }
            .header {
                flex-direction: column;
                align-items: stretch;
            }
            .form-container {
                width: 98%;
                padding: 15px;
            }
            .toast {
                top: 10px;
                right: 10px;
                left: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- ç™»å½•è¡¨å• -->
    <div class="login-container" id="login-container">
        <h2 class="login-title">ä»»åŠ¡ç®¡ç†å™¨ç™»å½•</h2>
        <input type="password" id="password-input" class="login-input" placeholder="è¯·è¾“å…¥è®¿é—®å¯†ç ">
        <div class="login-error" id="login-error">å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•</div>
        <button class="login-btn" onclick="checkPassword()">ç™»å½•</button>
    </div>

    <!-- åº”ç”¨å†…å®¹ -->
    <div id="app-content" style="display:none;">
        <div class="header">
            <h1>æˆ‘çš„ä¸ªäººä»»åŠ¡ç®¡ç†å™¨</h1>
            <button class="btn-primary" onclick="showProjectForm()">+ æ·»åŠ æ–°é¡¹ç›®</button>
        </div>

        <div id="toast" class="toast"></div>

        <div class="sort-buttons">
            <button class="btn-sort active" onclick="changeSortMode('default')" id="sort-default">ğŸ“… é»˜è®¤æ’åº</button>
            <button class="btn-sort" onclick="changeSortMode('completed')" id="sort-completed">âœ… æŒ‰å·²å®Œæˆ</button>
            <button class="btn-sort" onclick="changeSortMode('incomplete')" id="sort-incomplete">â³ æŒ‰æœªå®Œæˆ</button>
        </div>

        <div class="stats" id="stats-container"></div>

        <div class="projects-grid" id="project-list"></div>

        <div class="overlay" id="form-overlay" onclick="hideProjectForm()"></div>
        <div class="form-container" id="project-form-container">
            <h3 class="form-title" id="form-title">æ·»åŠ æ–°é¡¹ç›®</h3>
            <form id="project-form" onsubmit="saveProject(event)">
                <input type="hidden" id="project-id" value="">
                
                <div class="form-group">
                    <label for="project-name">é¡¹ç›®åç§°</label>
                    <input type="text" id="project-name" placeholder="ä¾‹å¦‚ï¼šé‚®å‚¨ä¿¡ç”¨å¡é¢†åˆ¸" required>
                </div>

                <div class="form-group">
                    <label for="project-description">é¡¹ç›®ä»‹ç»ï¼ˆå¯é€‰ï¼‰</label>
                    <textarea id="project-description" placeholder="ç®€è¦æè¿°è¿™ä¸ªé¡¹ç›®çš„å…·ä½“å†…å®¹..."></textarea>
                </div>

                <div class="form-section">
                    <div class="form-section-title">ç”¨æˆ·æ ‡ç­¾è®¾ç½®</div>
                    <div class="form-group">
                        <label>ç”¨æˆ·æ ‡ç­¾ï¼ˆç”¨äºåŒºåˆ†ä¸åŒè´¦æˆ·ï¼‰</label>
                        <div class="tag-input-group">
                            <input type="text" id="new-tag" class="tag-input" placeholder="è¾“å…¥æ ‡ç­¾åç§°" maxlength="10">
                            <button type="button" class="add-tag-btn" onclick="addUserTag()">æ·»åŠ </button>
                        </div>
                        <div class="tag-list" id="tag-list"></div>
                        <small>æ·»åŠ å¤šä¸ªæ ‡ç­¾æ¥åŒºåˆ†ä¸åŒè´¦æˆ·çš„ç›¸åŒä»»åŠ¡</small>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="form-section-title">æ‰§è¡Œæ—¶é—´è®¾ç½®</div>
                    
                    <div class="form-group">
                        <label for="project-type">æ‰§è¡Œé¢‘ç‡</label>
                        <select id="project-type" onchange="toggleScheduleFields()" required>
                            <option value="daily">æ¯æ—¥å›ºå®šæ—¶é—´</option>
                            <option value="weekly">æ¯å‘¨å›ºå®šæ—¶é—´</option>
                            <option value="monthly">æ¯æœˆå›ºå®šæ—¥æœŸ</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="weekday-group" style="display:none;">
                        <label for="project-weekday">æ˜ŸæœŸå‡ æ‰§è¡Œ</label>
                        <select id="project-weekday">
                            <option value="0">å‘¨æ—¥</option>
                            <option value="1">å‘¨ä¸€</option>
                            <option value="2">å‘¨äºŒ</option>
                            <option value="3">å‘¨ä¸‰</option>
                            <option value="4">å‘¨å››</option>
                            <option value="5">å‘¨äº”</option>
                            <option value="6">å‘¨å…­</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="day-of-month-group" style="display:none;">
                        <label for="project-day">æ¯æœˆå‡ å·æ‰§è¡Œ</label>
                        <input type="number" id="project-day" min="1" max="31" value="1">
                    </div>
                    
                    <div class="form-group">
                        <label for="project-hour">å…·ä½“æ—¶é—´</label>
                        <input type="time" id="project-hour" value="10:00" required>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">è¿›åº¦è®¾ç½®</div>
                    
                    <div class="form-group">
                        <label for="project-total">æœˆåº¦æ¬¡æ•°è®¡ç®—æ–¹å¼</label>
                        <select id="project-total" onchange="toggleCustomTotal()">
                            <option value="auto">è‡ªåŠ¨è®¡ç®—</option>
                            <option value="custom" selected>è‡ªå®šä¹‰å›ºå®šæ¬¡æ•°</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="custom-total-group" style="display:block;">
                        <label for="project-custom-total">æ¯æœˆå›ºå®šæ¬¡æ•°</label>
                        <input type="number" id="project-custom-total" min="1" value="1">
                    </div>

                    <div class="form-group">
                        <label for="project-reset">è¿›åº¦é‡ç½®æ–¹å¼</label>
                        <select id="project-reset">
                            <option value="monthly">æ¯æœˆ1æ—¥è‡ªåŠ¨é‡ç½®</option>
                            <option value="manual">æ‰‹åŠ¨é‡ç½®</option>
                            <option value="none">ä¸é‡ç½®</option>
                        </select>
                        <small>æ¯æœˆé‡ç½®ï¼šæ¯æœˆ1æ—¥0ç‚¹è‡ªåŠ¨æ¸…ç©ºè¿›åº¦</small>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">æœ‰æ•ˆæœŸè®¾ç½®</div>
                    <div class="form-group">
                        <label for="project-end">ç»“æŸæ—¥æœŸï¼ˆå¯é€‰ï¼‰</label>
                        <input type="date" id="project-end">
                        <small>ä¸å¡«åˆ™æ°¸ä¹…æœ‰æ•ˆï¼Œåˆ°æœŸåè‡ªåŠ¨éšè—</small>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn-danger" id="delete-btn" style="display:none;" onclick="deleteProject()">åˆ é™¤é¡¹ç›®</button>
                    <button type="button" class="btn-edit" onclick="hideProjectForm()">å–æ¶ˆ</button>
                    <button type="submit" class="btn-success">ä¿å­˜é¡¹ç›®</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Airtable é…ç½®
        const AIRTABLE_CONFIG = {
            BASE_ID: 'appQ3lMrE7D8COXg8',
            API_KEY: 'patWnWNrI0X22Th53.08624da32545cf7efb372f9ecd57b5d4d72783c8b63d3385d87d49b1d71581e1',
            PROJECTS_TABLE: 'projects',
            CONFIG_TABLE: 'config'
        };

        // å…¨å±€å˜é‡
        let projects = [];
        let currentSortMode = 'default';
        let userTags = [];
        let isAuthenticated = false;

        // Airtable API å‡½æ•°
        async function airtableRequest(endpoint, options = {}) {
            const url = `https://api.airtable.com/v0/${AIRTABLE_CONFIG.BASE_ID}/${endpoint}`;
            console.log('Airtable Request URL:', url);
            
            const headers = {
                'Authorization': `Bearer ${AIRTABLE_CONFIG.API_KEY}`,
                'Content-Type': 'application/json',
                ...options.headers
            };

            try {
                const response = await fetch(url, { ...options, headers });
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Airtable API error response:', errorText);
                    throw new Error(`Airtable API error: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Airtable request failed:', error);
                showToast('ç½‘ç»œè¯·æ±‚å¤±è´¥: ' + error.message, 'error');
                throw error;
            }
        }

        // å¯†ç éªŒè¯å‡½æ•°
        async function checkPassword() {
            const passwordInput = document.getElementById('password-input');
            const password = passwordInput.value.trim();
            const errorElement = document.getElementById('login-error');

            if (!password) {
                errorElement.textContent = 'è¯·è¾“å…¥å¯†ç ';
                errorElement.style.display = 'block';
                return;
            }

            try {
                // ä» Airtable è·å–å¯†ç 
                const result = await airtableRequest(`${AIRTABLE_CONFIG.CONFIG_TABLE}?filterByFormula={key}='password'`);
                
                if (result.records.length === 0) {
                    // ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Œè®¾ç½®å¯†ç 
                    await airtableRequest(AIRTABLE_CONFIG.CONFIG_TABLE, {
                        method: 'POST',
                        body: JSON.stringify({
                            records: [{
                                fields: {
                                    key: 'password',
                                    value: password,
                                    type: 'auth'
                                }
                            }]
                        })
                    });
                    localStorage.setItem('app_password', password);
                    showAppContent();
                } else {
                    const storedPassword = result.records[0].fields.value;
                    if (password === storedPassword) {
                        localStorage.setItem('app_password', password);
                        showAppContent();
                    } else {
                        errorElement.textContent = 'å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•';
                        errorElement.style.display = 'block';
                    }
                }
            } catch (error) {
                errorElement.textContent = 'éªŒè¯å¤±è´¥: ' + error.message;
                errorElement.style.display = 'block';
            }
        }

        function showAppContent() {
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('app-content').style.display = 'block';
            isAuthenticated = true;
            loadData();
        }

        // æ•°æ®åŠ è½½å‡½æ•°
        async function loadData() {
            try {
                showToast('æ­£åœ¨åŠ è½½æ•°æ®...', 'info');
                
                // åŠ è½½é¡¹ç›®æ•°æ®
                const projectsResult = await airtableRequest(AIRTABLE_CONFIG.PROJECTS_TABLE);
                projects = projectsResult.records.map(record => {
                    const fields = record.fields;
                    return {
                        id: record.id,
                        name: fields.name || '',
                        description: fields.description || '',
                        type: fields.type || 'daily',
                        rule: typeof fields.rule === 'string' ? JSON.parse(fields.rule) : (fields.rule || { hour: '10:00' }),
                        resetType: fields.resetType || 'monthly',
                        endDate: fields.endDate || null,
                        userTags: typeof fields.userTags === 'string' ? JSON.parse(fields.userTags) : (fields.userTags || ['é»˜è®¤']),
                        tagProgress: typeof fields.tagProgress === 'string' ? JSON.parse(fields.tagProgress) : (fields.tagProgress || {}),
                        currentTag: fields.currentTag || 'é»˜è®¤',
                        createdAt: fields.createdAt || new Date().toISOString()
                    };
                });
                
                showToast(`åŠ è½½äº† ${projects.length} ä¸ªé¡¹ç›®`, 'success', 2000);
                renderProjects();
            } catch (error) {
                showToast('æ•°æ®åŠ è½½å¤±è´¥: ' + error.message, 'error');
                projects = [];
                renderProjects();
            }
        }

        // æ•°æ®ä¿å­˜å‡½æ•°
        async function saveData() {
            try {
                showToast('æ­£åœ¨åŒæ­¥æ•°æ®...', 'info');
                
                // ç®€åŒ–çš„ä¿å­˜é€»è¾‘
                for (const project of projects) {
                    const fields = {
                        name: project.name,
                        description: project.description || '',
                        type: project.type,
                        rule: JSON.stringify(project.rule),
                        resetType: project.resetType,
                        endDate: project.endDate,
                        userTags: JSON.stringify(project.userTags),
                        tagProgress: JSON.stringify(project.tagProgress),
                        currentTag: project.currentTag
                    };
                    
                    if (project.id && project.id.startsWith('rec')) {
                        // æ›´æ–°ç°æœ‰è®°å½•
                        await airtableRequest(`${AIRTABLE_CONFIG.PROJECTS_TABLE}/${project.id}`, {
                            method: 'PATCH',
                            body: JSON.stringify({ fields })
                        });
                    } else {
                        // åˆ›å»ºæ–°è®°å½•
                        const result = await airtableRequest(AIRTABLE_CONFIG.PROJECTS_TABLE, {
                            method: 'POST',
                            body: JSON.stringify({ records: [{ fields }] })
                        });
                        project.id = result.records[0].id;
                    }
                }
                
                showToast('æ•°æ®åŒæ­¥å®Œæˆ', 'success');
                return true;
            } catch (error) {
                showToast('æ•°æ®ä¿å­˜å¤±è´¥: ' + error.message, 'error');
                return false;
            }
        }

        // åˆ é™¤é¡¹ç›®å‡½æ•°
        async function deleteProject() {
            const id = document.getElementById('project-id').value;
            if (id && confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) {
                try {
                    const project = projects.find(p => p.id === id);
                    projects = projects.filter(p => p.id !== id);
                    
                    // ä» Airtable åˆ é™¤
                    await airtableRequest(`${AIRTABLE_CONFIG.PROJECTS_TABLE}/${id}`, {
                        method: 'DELETE'
                    });
                    
                    hideProjectForm();
                    renderProjects();
                    showToast(`å·²åˆ é™¤: ${project.name}`, 'info');
                } catch (error) {
                    showToast('åˆ é™¤å¤±è´¥', 'error');
                }
            }
        }

        // å·¥å…·å‡½æ•°
        function showToast(message, type = 'info', duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), duration);
        }

        function addUserTag() {
            const tagInput = document.getElementById('new-tag');
            const tagName = tagInput.value.trim();
            if (!tagName) return showToast('è¯·è¾“å…¥æ ‡ç­¾åç§°', 'error');
            if (userTags.includes(tagName)) return showToast('æ ‡ç­¾å·²å­˜åœ¨', 'error');
            userTags.push(tagName);
            renderTagList();
            tagInput.value = '';
        }

        function removeUserTag(tagName) {
            userTags = userTags.filter(tag => tag !== tagName);
            renderTagList();
        }

        function renderTagList() {
            const tagList = document.getElementById('tag-list');
            tagList.innerHTML = userTags.map(tag => `
                <div class="tag-item">
                    <span>${tag}</span>
                    <span class="remove-tag" onclick="removeUserTag('${tag}')">Ã—</span>
                </div>
            `).join('');
        }

        function switchUserTag(projectId, tagName) {
            const project = projects.find(p => p.id === projectId);
            if (project) {
                project.currentTag = tagName;
                renderProjects();
                saveData();
            }
        }

        function completeProjectForTag(projectId, tagName) {
            const project = projects.find(p => p.id === projectId);
            if (project && project.tagProgress) {
                project.tagProgress[tagName] = (project.tagProgress[tagName] || 0) + 1;
                showToast(`å·²å®Œæˆ: ${project.name} (${tagName})`, 'success');
                renderProjects();
                saveData();
            }
        }

        function generateUniqueId() {
            return Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // é¡¹ç›®æ˜¾ç¤ºç›¸å…³å‡½æ•°
        function checkMonthlyReset() {
            const now = new Date();
            if (now.getDate() === 1) {
                let resetCount = 0;
                projects.forEach(project => {
                    if (project.resetType === 'monthly' && project.tagProgress) {
                        Object.keys(project.tagProgress).forEach(tag => {
                            if (project.tagProgress[tag] > 0) {
                                project.tagProgress[tag] = 0;
                                resetCount++;
                            }
                        });
                    }
                });
                if (resetCount > 0) {
                    saveData();
                    showToast(`è‡ªåŠ¨é‡ç½®äº† ${resetCount} ä¸ªç”¨æˆ·æ ‡ç­¾çš„è¿›åº¦`, 'info');
                }
            }
        }

        function calculateNextScheduledTime(project) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const [hours, minutes] = project.rule.hour.split(':').map(Number);

            if (project.type === 'daily') {
                let nextDate = new Date(today.getFullYear(), today.getMonth(), today.getDate(), hours, minutes, 0);
                if (nextDate < now) nextDate.setDate(nextDate.getDate() + 1);
                return nextDate.getTime();
            } else if (project.type === 'weekly') {
                const targetDay = project.rule.weekday;
                let nextDate = new Date(today);
                let dayDelta = targetDay - today.getDay();
                if (dayDelta < 0 || (dayDelta === 0 && (now.getHours() > hours || (now.getHours() === hours && now.getMinutes() >= minutes)))) {
                    dayDelta += 7;
                }
                nextDate.setDate(today.getDate() + dayDelta);
                return new Date(nextDate.getFullYear(), nextDate.getMonth(), nextDate.getDate(), hours, minutes, 0).getTime();
            } else {
                const targetDay = project.rule.dayOfMonth || 1;
                let nextDate = new Date(today.getFullYear(), today.getMonth(), targetDay, hours, minutes, 0);
                if (nextDate < now) {
                    nextDate = new Date(today.getFullYear(), today.getMonth() + 1, targetDay, hours, minutes, 0);
                }
                return nextDate.getTime();
            }
        }

        function getNumberOfSpecificDaysInMonth(project) {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            
            if (project.type === 'daily') {
                return new Date(year, month + 1, 0).getDate();
            } else if (project.type === 'weekly') {
                const targetDay = project.rule.weekday;
                const date = new Date(year, month, 1);
                let count = 0;
                while (date.getMonth() === month) {
                    if (date.getDay() === targetDay) count++;
                    date.setDate(date.getDate() + 1);
                }
                return count;
            } else {
                return 1;
            }
        }

        function calculateProgress(project) {
            const currentTag = project.currentTag || project.userTags[0];
            const completed = project.tagProgress ? (project.tagProgress[currentTag] || 0) : 0;
            const denominator = project.rule.monthlyTotal || getNumberOfSpecificDaysInMonth(project);
            const progress = (completed / denominator) * 100;
            return {
                progress: progress > 100 ? 100 : progress,
                text: `${completed} / ${denominator}`,
                denominator: denominator,
                completed: completed
            };
        }

        function calculateTotalStats() {
            let totalCompleted = 0;
            let totalTasks = 0;

            projects.forEach(project => {
                if (!checkIsExpired(project)) {
                    const denominator = project.rule.monthlyTotal || getNumberOfSpecificDaysInMonth(project);
                    if (project.tagProgress) {
                        Object.values(project.tagProgress).forEach(completed => {
                            totalCompleted += completed;
                        });
                    }
                    if (project.userTags) {
                        totalTasks += denominator * project.userTags.length;
                    }
                }
            });

            return { totalCompleted, totalTasks };
        }

        function checkIsExpired(project) {
            return project.endDate ? new Date() > new Date(project.endDate) : false;
        }

        function getSortedProjects() {
            checkMonthlyReset();
            const activeProjects = projects.filter(p => !checkIsExpired(p));
            activeProjects.forEach(p => {
                p.nextScheduledTime = calculateNextScheduledTime(p);
                p.progressInfo = calculateProgress(p);
            });

            switch (currentSortMode) {
                case 'completed':
                    activeProjects.sort((a, b) => b.progressInfo.progress - a.progressInfo.progress);
                    break;
                case 'incomplete':
                    activeProjects.sort((a, b) => a.progressInfo.progress - b.progressInfo.progress);
                    break;
                default:
                    activeProjects.sort((a, b) => {
                        const aCompleted = a.progressInfo.progress >= 100;
                        const bCompleted = b.progressInfo.progress >= 100;
                        if (aCompleted && !bCompleted) return 1;
                        if (!aCompleted && bCompleted) return -1;
                        return a.nextScheduledTime - b.nextScheduledTime;
                    });
            }
            return activeProjects;
        }

        function changeSortMode(mode) {
            currentSortMode = mode;
            document.getElementById('sort-default').classList.toggle('active', mode === 'default');
            document.getElementById('sort-completed').classList.toggle('active', mode === 'completed');
            document.getElementById('sort-incomplete').classList.toggle('active', mode === 'incomplete');
            renderProjects();
        }

        function renderStats() {
            const container = document.getElementById('stats-container');
            const activeProjects = projects.filter(p => !checkIsExpired(p));
            const { totalCompleted, totalTasks } = calculateTotalStats();
            
            const totalProgress = activeProjects.reduce((sum, project) => {
                const progress = calculateProgress(project);
                return sum + (progress.progress / 100) * progress.denominator;
            }, 0);
            
            const completionRate = totalTasks > 0 ? (totalCompleted / totalTasks * 100).toFixed(1) : 0;

            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${activeProjects.length}</div>
                    <div class="stat-label">æ´»è·ƒé¡¹ç›®</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${completionRate}%</div>
                    <div class="stat-label">æœ¬æœˆå®Œæˆç‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${totalCompleted}</div>
                    <div class="stat-label">å·²å®Œæˆæ¬¡æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${totalTasks}</div>
                    <div class="stat-label">æ€»ä»»åŠ¡æ•°</div>
                </div>
            `;
        }

        function renderProjects() {
            const container = document.getElementById('project-list');
            const sortedProjects = getSortedProjects();
            renderStats();

            if (sortedProjects.length === 0) {
                container.innerHTML = '<div class="empty-state">è¿˜æ²¡æœ‰é¡¹ç›®<br><br><button class="btn-primary" onclick="showProjectForm()">æ·»åŠ ç¬¬ä¸€ä¸ªé¡¹ç›®</button></div>';
                return;
            }

            container.innerHTML = sortedProjects.map(project => {
                const nextTime = new Date(project.nextScheduledTime);
                const [hours, minutes] = project.rule.hour.split(':');
                
                let timeDisplay = '';
                if (project.type === 'daily') {
                    timeDisplay = `æ¯æ—¥ <span class="time-display">${hours}:${minutes.padStart(2, '0')}</span>`;
                } else if (project.type === 'weekly') {
                    const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
                    timeDisplay = `æ¯å‘¨<span class="time-display">${weekdays[project.rule.weekday]} ${hours}:${minutes.padStart(2, '0')}</span>`;
                } else {
                    timeDisplay = `æ¯æœˆ<span class="time-display">${project.rule.dayOfMonth}æ—¥ ${hours}:${minutes.padStart(2, '0')}</span>`;
                }

                const timeString = nextTime.toLocaleString('zh-CN', { 
                    month: 'short', 
                    day: 'numeric',
                    weekday: 'short'
                });

                const isCompleted = project.progressInfo.progress >= 100;
                const sameNameCount = projects.filter(p => p.name === project.name).length;
                const nameSuffix = sameNameCount > 1 ? ` #${projects.filter(p => p.name === project.name).findIndex(p => p.id === project.id) + 1}` : '';
                const currentTag = project.currentTag || project.userTags[0];

                return `
                    <div class="project-card" style="opacity: ${isCompleted ? '0.8' : '1'}; border-left-color: ${isCompleted ? '#95a5a6' : '#3498db'}">
                        <div class="project-header">
                            <div class="project-title">
                                ${project.resetType === 'monthly' ? '<span class="reset-badge">æ¯æœˆé‡ç½®</span>' : ''}
                                ${project.name}${nameSuffix} ${isCompleted ? 'âœ…' : ''}
                            </div>
                            <button class="btn-edit" onclick="showProjectForm('${project.id}')">ç¼–è¾‘</button>
                        </div>
                        <div class="project-description">${project.description || 'æš‚æ— ä»‹ç»'}</div>
                        <div class="project-meta">
                            <div>${timeDisplay} | ä¸‹æ¬¡: <span class="next-time">${timeString}</span> ${project.endDate ? `| æˆªæ­¢: ${project.endDate}` : ''}</div>
                        </div>
                        <div class="progress-container">
                            <div class="progress-bar"><div class="progress" style="width: ${project.progressInfo.progress}%"></div></div>
                            <div class="progress-text">${project.progressInfo.text} (${project.progressInfo.progress.toFixed(1)}%)</div>
                        </div>
                        <div class="project-actions">
                            <button class="btn-success" onclick="completeProjectForTag('${project.id}', '${currentTag}')" ${isCompleted ? 'disabled style="background:#95a5a6;"' : ''}>âœ… å®Œæˆ</button>
                            <button class="btn-edit" onclick="resetProject('${project.id}')">ğŸ”„ é‡ç½®</button>
                        </div>
                        <div class="user-tags">
                            ${project.userTags.map(tag => `
                                <div class="user-tag ${tag === currentTag ? 'active' : ''}" 
                                     onclick="switchUserTag('${project.id}', '${tag}')">
                                    ${tag}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function resetProject(projectId) {
            const project = projects.find(p => p.id === projectId);
            if (project && confirm('ç¡®å®šé‡ç½®å½“å‰è´¦æˆ·çš„è¿›åº¦ï¼Ÿ')) { 
                const currentTag = project.currentTag || project.userTags[0];
                if (project.tagProgress) {
                    project.tagProgress[currentTag] = 0;
                }
                showToast(`å·²é‡ç½®: ${project.name} (${currentTag})`, 'info');
                renderProjects(); 
                saveData(); 
            }
        }

        // è¡¨å•ç›¸å…³å‡½æ•°
        function showProjectForm(projectId = null) {
            const form = document.getElementById('project-form');
            form.reset();
            document.getElementById('project-id').value = '';
            userTags = [];
            
            if (projectId) {
                document.getElementById('form-title').textContent = 'ç¼–è¾‘é¡¹ç›®';
                document.getElementById('delete-btn').style.display = 'block';
                const project = projects.find(p => p.id == projectId);
                if (project) {
                    document.getElementById('project-id').value = project.id;
                    document.getElementById('project-name').value = project.name;
                    document.getElementById('project-description').value = project.description || '';
                    document.getElementById('project-type').value = project.type;
                    document.getElementById('project-hour').value = project.rule.hour;
                    document.getElementById('project-reset').value = project.resetType || 'monthly';
                    
                    userTags = [...(project.userTags || ['é»˜è®¤'])];
                    renderTagList();
                    
                    if (project.type === 'weekly') {
                        document.getElementById('project-weekday').value = project.rule.weekday;
                    } else if (project.type === 'monthly') {
                        document.getElementById('project-day').value = project.rule.dayOfMonth;
                    }
                    
                    if (project.rule.monthlyTotal) {
                        document.getElementById('project-total').value = 'custom';
                        document.getElementById('project-custom-total').value = project.rule.monthlyTotal;
                        toggleCustomTotal();
                    } else {
                        document.getElementById('project-total').value = 'auto';
                        toggleCustomTotal();
                    }
                    
                    if (project.endDate) {
                        document.getElementById('project-end').value = project.endDate;
                    }
                    
                    toggleScheduleFields();
                }
            } else {
                document.getElementById('form-title').textContent = 'æ·»åŠ æ–°é¡¹ç›®';
                document.getElementById('delete-btn').style.display = 'none';
                userTags = ['é»˜è®¤'];
                renderTagList();
                
                // è®¾ç½®é»˜è®¤å€¼ä¸ºè‡ªå®šä¹‰å›ºå®šæ¬¡æ•°
                document.getElementById('project-total').value = 'custom';
                document.getElementById('project-custom-total').value = '1';
                toggleCustomTotal();
            }
            
            document.getElementById('form-overlay').style.display = 'block';
            document.getElementById('project-form-container').style.display = 'block';
        }

        function hideProjectForm() {
            document.getElementById('form-overlay').style.display = 'none';
            document.getElementById('project-form-container').style.display = 'none';
        }

        function toggleScheduleFields() {
            const type = document.getElementById('project-type').value;
            document.getElementById('weekday-group').style.display = type === 'weekly' ? 'block' : 'none';
            document.getElementById('day-of-month-group').style.display = type === 'monthly' ? 'block' : 'none';
        }

        function toggleCustomTotal() {
            const totalType = document.getElementById('project-total').value;
            document.getElementById('custom-total-group').style.display = totalType === 'custom' ? 'block' : 'none';
        }

        async function saveProject(event) {
            event.preventDefault();
            
            const id = document.getElementById('project-id').value;
            const name = document.getElementById('project-name').value;
            const description = document.getElementById('project-description').value;
            const type = document.getElementById('project-type').value;
            const hour = document.getElementById('project-hour').value;
            const resetType = document.getElementById('project-reset').value;
            const endDate = document.getElementById('project-end').value || null;
            
            let rule = { hour: hour };
            if (type === 'weekly') {
                rule.weekday = parseInt(document.getElementById('project-weekday').value);
            } else if (type === 'monthly') {
                rule.dayOfMonth = parseInt(document.getElementById('project-day').value);
            }
            
            const totalType = document.getElementById('project-total').value;
            if (totalType === 'custom') {
                rule.monthlyTotal = parseInt(document.getElementById('project-custom-total').value);
            } else {
                rule.monthlyTotal = null; // æ¸…é™¤è‡ªå®šä¹‰æ¬¡æ•°
            }
            
            if (id) {
                const index = projects.findIndex(p => p.id == id);
                if (index !== -1) {
                    const oldProject = projects[index];
                    const tagProgress = { ...oldProject.tagProgress };
                    userTags.forEach(tag => {
                        if (!tagProgress[tag]) tagProgress[tag] = 0;
                    });
                    Object.keys(tagProgress).forEach(tag => {
                        if (!userTags.includes(tag)) delete tagProgress[tag];
                    });
                    
                    projects[index] = { 
                        ...oldProject,
                        name, description, type, rule, resetType, endDate,
                        userTags: [...userTags],
                        tagProgress,
                        currentTag: oldProject.currentTag && userTags.includes(oldProject.currentTag) ? oldProject.currentTag : userTags[0]
                    };
                    showToast(`å·²æ›´æ–°: ${name}`, 'success');
                }
            } else {
                const newId = generateUniqueId();
                const tagProgress = {};
                userTags.forEach(tag => tagProgress[tag] = 0);
                
                const newProject = { 
                    id: newId, name, description, type, rule, 
                    resetType: resetType || 'monthly', endDate,
                    userTags: [...userTags], tagProgress, currentTag: userTags[0]
                };
                projects.push(newProject);
                showToast(`å·²æ·»åŠ : ${name}`, 'success');
            }
            
            hideProjectForm();
            renderProjects();
            await saveData();
        }

        // åˆå§‹åŒ–åº”ç”¨
        function initApp() {
            const savedPassword = localStorage.getItem('app_password');
            const loginContainer = document.getElementById('login-container');
            const appContent = document.getElementById('app-content');
            
            if (savedPassword) {
                // è‡ªåŠ¨éªŒè¯å¯†ç 
                document.getElementById('password-input').value = savedPassword;
                checkPassword();
            } else {
                loginContainer.style.display = 'block';
                appContent.style.display = 'none';
            }
            
            // æ·»åŠ å›è½¦é”®ç™»å½•æ”¯æŒ
            document.getElementById('password-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    checkPassword();
                }
            });

            // ç¡®ä¿è‡ªå®šä¹‰æ¬¡æ•°è¾“å…¥æ¡†åˆå§‹çŠ¶æ€æ­£ç¡®
            toggleCustomTotal();
        }

        // å¯åŠ¨åº”ç”¨
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>